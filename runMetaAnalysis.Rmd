# Meta-analysis

Load tidy data.

```{r}
f <- "AllStudies.RData"
load(f, verbose=TRUE)
metadata$timeStamp
metadata$colNames
```

Merge pre-treatment measures to 12+ month post-treatment measures.

```{r}
D[, .N, .(author, monthsPostTx)][order(author, monthsPostTx)]
DPre  <- D[monthsPostTx == 0]
DPre [, .N, .(author, monthsPostTx)][order(author, monthsPostTx)]
DPost <- D[12 <= monthsPostTx]
DPost[, .N, .(author, monthsPostTx)][order(author, monthsPostTx)]
key <- c("author", "cognitiveDomain", "cognitiveTest", "isTimed", "scoreType")
setkeyv(DPre , key)
setkeyv(DPost, key)
D <- merge(DPre, DPost, suffixes=c("Pre", "Post"))
```

If the cognitive test is a timed test,
then flip the signs so the pre-post difference will have the same direction as score tests.

```{r}
D <- D[isTimed == TRUE,
       `:=` (meanPre = -meanPre,
             meanPost = -meanPost)]
message(sprintf("%d rows were flipped", nrow(D[isTimed == TRUE])))
```

Calculate effect sizes.

```{r}
calcFixed <- function (D) {
  escalc("SMD", data=D,
         m1i=meanPost, sd1i=sdPost, n1i=nPost,
         m2i=meanPre,  sd2i=sdPre,  n2i=nPre)
}
l <- list(calcFixed(D[cognitiveDomain == "Attn/Wkg Mem/Concentration"]),
          calcFixed(D[cognitiveDomain == "Verbal Memory"]),
          calcFixed(D[cognitiveDomain == "Visual Memory"]),
          calcFixed(D[cognitiveDomain == "Verbal Ability/Language"]),
          calcFixed(D[cognitiveDomain == "Motor Speed"]),
          calcFixed(D[cognitiveDomain == "Information Proc Speed"]),
          calcFixed(D[cognitiveDomain == "Exec Fxn"]),
          calcFixed(D[cognitiveDomain == "Visuospatial"]))
D <- rbindlist(l)
```

```{r}
domains <- unique(D[, cognitiveDomain])
models <- list()
for (i in 1:length(domains)) {
  models[[i]] <- rma(yi, vi, data=D[cognitiveDomain == domains[i]])
  show(list(i = i, domain = domains[i], model = models[i]))
}
```


Save working data tables to file.

```{r}
metadata <- makeMetadata(D)
f <- "metaAnalysisCognitiveImpairment.RData"
save(D, metadataD, domains, models, file=f)
message(sprintf("%s saved on: %s\nFile size: %s KB", 
                f,
                file.mtime(f),
                file.size(f) / 1e3))
```


## Plots of effect sizes by domain

