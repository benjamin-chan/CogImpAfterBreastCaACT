# Meta-analysis

Cognitive impairment is modeled with a multilevel random effects model.
Cognitive domain is modeled as a fixed effect, one effect size for each of the 8 domains.

In our study, we have multiple measurements within cognitive domain.
So, data points are correlated within study.

Random effects are assumed for cognitive test within study.
The variance component for cognitive test assumes each test is drawn from a large population of tests
The within study component models the correlation of test results within each study.

Mathematically, the model is represented as

$$
y = \sum_{i=1}^\text{# of domains} \beta_i + z_j \tau_{\text{test within study} j}
$$

A model to estimate a global effect is

$$
y = \beta + z_j \tau_{\text{test within study} j}
$$

Models were estimated using the `rma.mv()` function from the `metafor` package for R.
[Viechtbauer](http://www.jstatsoft.org/v36/i03/), W. (2010).
Conducting meta-analyses in R with the metafor package. *Journal of Statistical Software*, 36(3), 1-48.
An additional reference is

[Konstantopoulos, S. (2011)](http://onlinelibrary.wiley.com/doi/10.1002/jrsm.35/abstract), Fixed effects and variance components estimation in three-level meta-analysis. *Res. Synth. Method*, 2: 61-76. doi: 10.1002/jrsm.35

Load tidy data.

```{r}
f <- sprintf("%s/%s", pathOut, "AllStudies.RData")
load(f, verbose=TRUE)
metadata$timeStamp
metadata$colNames
```


## Pooled domain effects

* M0 models domain effects using fixed effects for test and study (only for comparison)
* M1 models domain effects using multilevel random effects for test within study
* M2 models the global effect using multilevel random effects for test within study

```{r}
randomEffects <- list(~ id | author)
M0 <- rma.mv(yi ~ domain - 1,
             vi,
             data=D,
             slab=sprintf("%s: %s", author, test))
M1 <- rma.mv(yi ~ domain - 1,
             vi,
             random = randomEffects,
             data=D,
             slab=sprintf("%s: %s", author, test))
M2 <- rma.mv(yi,
             vi,
             random = randomEffects,
             data=D)
```

```{r, results='asis'}
summary <- rbind(data.frame(studies = D[, .(studies = uniqueN(author)), domain][, studies],
                            tests = D[, .N, domain][, N],
                            M1[c("b", "se", "zval", "pval", "ci.lb", "ci.ub")]),
                 data.frame(studies = D[, .(studies = uniqueN(author))][, studies],
                            tests = D[, .N],
                            M2[c("b", "se", "zval", "pval", "ci.lb", "ci.ub")]))
rownames(summary) <- gsub("domain", "", rownames(summary))
rownames(summary) <- gsub("intrcpt", "**GLOBAL**", rownames(summary))
print(xtable(summary, digits=c(0, rep(0, 2), rep(3, 3), 4, rep(3, 2))), type="html")
```

The intraclass correlation within study is `r sprintf("%.3g", M1$rho)`, or `r sprintf("%.3g%%", M1$rho * 100)`.

```{r}
summary(M0)
summary(M1)
summary(M2)
```


Save working data tables to file.

```{r}
metadata <- makeMetadata(D)
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment.RData")
save(D, metadata, M1, M2, summary, file=f)
message(sprintf("%s saved on: %s\nFile size: %s KB", 
                f,
                file.mtime(f),
                file.size(f) / 1e3))
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment-Data.csv")
write.csv(D, file=f, row.names=FALSE)
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment-summary.csv")
write.csv(summary, file=f, row.names=FALSE)
```


## Plot of effect sizes

```{r forest, echo=FALSE}
lower <- D$yi + qnorm(0.025) * sqrt(D$vi)
upper <- D$yi + qnorm(0.975) * sqrt(D$vi)
alim <- c(floor(min(lower, na.rm=TRUE)), ceiling(max(upper, na.rm=TRUE)))
xlim <- c(-10, 8)
at <- seq(floor(min(lower, na.rm=TRUE)), ceiling(max(upper, na.rm=TRUE)), 1)
f <- sprintf("%s/%s", pathOut, "forest.png")
png(f, width=6, height=20, units="in", res=600)
cex <- 1/2
forest(M1,
       order=order(D[, sprintf("%s %s %s", domain, author, test)], decreasing=TRUE),
       rows=c(3:6, 11:21, 26:42, 47:56, 61:70, 75:84, 89:102, 107:147),
       ylim=c(0, 151),
       addfit=FALSE,
       cex=cex,
       efac=0,
       alim=alim, xlim=xlim, at=at)
text(-10, c(148, 103, 85, 71, 57, 43, 22, 7), levels(D[, domain]),
     pos=4, cex=cex, font=2)
addpoly(M1$b, diag(M1$vb), M1$se, M1$ci.lb, M1$ci.ub,
        rows=c(106, 88, 74, 60, 46, 25, 10, 2),
        mlab=rep("Pooled domain effect", length(M1$b)), cex=cex, font=2, efac=cex)
addpoly(M2$b, diag(M2$vb), M2$se, M2$ci.lb, M2$ci.ub,
        rows=0,
        mlab="Pooled global effect", cex=cex, font=2, efac=cex)
text(-1, -2, "Impairment", adj=1, cex=cex)
text( 1, -2, "Improvement", adj=0, cex=cex)
dev.off()
```

Full resolution file is [here](Output/forest.png).


## Diagnostic plots

Check the profile likelihoods of the variance and correlation components.

```{r, include=FALSE}
par(mfrow=c(2, 1))
profile(M1)
par(mfrow=c(1, 1))
```

Funnel plot to check for publication bias.
See [*BMJ* 2011;342:d4002](http://www.bmj.com/content/343/bmj.d4002) for a guide to interpret funnel plots.

```{r funnel, echo=FALSE}
f <- sprintf("%s/%s", pathOut, "funnel.png")
png(f, width=6, height=6, units="in", res=600)
funnel(M1)
dev.off()
funnel(M1)
```

Publication bias does not appear to be a great concern.
