# Meta-analysis

Cognitive impairment is modeled with a multilevel mixed effects model.
Cognitive domain is modeled as a fixed effect, one effect size for each of the 8 domains.

In our study, we have multiple measurements within cognitive domain.
So, data points are correlated within study.

Random effects are assumed for cognitive test within study and domain (compound symmetric correlation structure) and for study.
The test-within-study-and-domain random effect models the correlation of test results within each study and domain.
The study random effect assumes each study is drawn from a large population of studies.

Mathematically, the model is represented as

$$
y = \sum_{i=1}^\text{# of domains} \beta_i + \sigma_\text{study} + \tau_{\text{test within study} \times \text{domain}}
$$

Models were estimated using the `rma.mv()` function from the `metafor` package for R.
[Viechtbauer](http://www.jstatsoft.org/v36/i03/), W. (2010).
Conducting meta-analyses in R with the metafor package. *Journal of Statistical Software*, 36(3), 1-48.

Load tidy data.

```{r}
f <- sprintf("%s/%s", pathOut, "AllStudies.RData")
load(f, verbose=TRUE)
metadata$timeStamp
metadata$colNames
```

## Pooled domain effects

```{r}
M <- rma.mv(yi ~ domain - 1,
            vi,
            random = list(~ test | intStudyDomain,
                          ~ 1 | author),
            struct="CS",
            data=D,
            slab=sprintf("%s: %s", author, test))
```

```{r, results='asis'}
summary <- data.frame(studies = D[, .(studies = uniqueN(author)), domain][, studies],
                      tests = D[, .N, domain][, N],
                      M[c("b", "se", "zval", "pval", "ci.lb", "ci.ub")])
rownames(summary) <- gsub("domain", "", rownames(summary))
print(xtable(summary, digits=c(0, rep(0, 2), rep(3, 3), 4, rep(3, 2))), type="html")
```

```{r}
summary(M)
```


Save working data tables to file.

```{r}
metadata <- makeMetadata(D)
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment.RData")
save(D, metadata, M, summary, file=f)
message(sprintf("%s saved on: %s\nFile size: %s KB", 
                f,
                file.mtime(f),
                file.size(f) / 1e3))
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment-Data.csv")
write.csv(D, file=f, row.names=FALSE)
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment-summary.csv")
write.csv(summary, file=f, row.names=FALSE)
```


## Plot of effect sizes

The `xlim` settings require fine-tuning.

```{r, echo=FALSE}
lower <- D$yi + qnorm(0.025) * sqrt(D$vi)
upper <- D$yi + qnorm(0.975) * sqrt(D$vi)
alim <- c(floor(min(lower, na.rm=TRUE)), ceiling(max(upper, na.rm=TRUE)))
xlim <- c(-10, 8)
at <- seq(floor(min(lower, na.rm=TRUE)), ceiling(max(upper, na.rm=TRUE)), 1)
```

```{r forest, echo=FALSE, fig.width=10, fig.height=30}
f <- sprintf("%s/%s", pathOut, "forest.png")
png(f, width=6, height=20, units="in", res=600)
cex <- 1/2
forest(M,
       order=order(D[, sprintf("%s %s %s", domain, author, test)], decreasing=TRUE),
       rows=c(3:6, 11:21, 26:42, 47:56, 61:70, 75:84, 89:102, 107:147),
       ylim=c(0, 151),
       addfit=FALSE,
       cex=cex,
       efac=0,
       alim=alim, xlim=xlim, at=at)
text(-10, c(148, 103, 85, 71, 57, 43, 22, 7), levels(D[, domain]),
     pos=4, cex=cex, font=2)
addpoly(M$b, diag(M$vb), M$se, M$ci.lb, M$ci.ub,
        rows=c(106, 88, 74, 60, 46, 25, 10, 2),
        mlab=rep("Pooled effect size", length(M$b)), cex=cex, font=2, efac=cex)
text(-1, -3, "Impairment", adj=1, cex=cex)
text( 1, -3, "Improvement", adj=0, cex=cex)
dev.off()
```

Full resolution file is [here](Output/forest.png).


## Plot to assess publication bias

See [*BMJ* 2011;342:d4002](http://www.bmj.com/content/343/bmj.d4002) for a guide to interpret funnel plots.

```{r funnel, echo=FALSE}
funnel(M)
```

Publication bias does not appear to be a great concern.
