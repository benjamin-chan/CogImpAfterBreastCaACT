# Meta-analysis

Cognitive impairment is modeled with a multilevel mixed effects model.
Fixed effect for cognitive domain is modeled, one effect size for each of the 8 domains.
The random effects model assumes each data point is a random observation from a large population of studies.
The single-level random effects model additionally assumes each data point is independent.
The multilevel random effects model relaxes the independence assumption,
allowing for data points to be correlated.
In our study, we have multiple measurements within cognitive domain.
So, data points are correlated within study.

Models were estimated using the `rma.mv()` function from the `metafor` package for R.
[Viechtbauer](http://www.jstatsoft.org/v36/i03/), W. (2010).
Conducting meta-analyses in R with the metafor package. *Journal of Statistical Software*, 36(3), 1-48.

Load tidy data.

```{r}
f <- sprintf("%s/%s", pathOut, "AllStudies.RData")
load(f, verbose=TRUE)
metadata$timeStamp
metadata$colNames
```

Remove studies with missing data.

```{r}
unique(D[is.na(yi), .(author, cognitiveDomain, cognitiveTest, yi)])
D <- D[!is.na(yi)]
```

Label each data point.
Will need this for the multilevel random effects model specification.

```{r}
D <- D[, j := factor(sequence(D[, .N, .(author, cognitiveDomain)][, N]))]
D <- D[, k := factor(1:nrow(D))]
```

## Pooled domain effects

```{r}
M <- rma.mv(yi ~ cognitiveDomain - 1,
            vi,
            random = list(~ cognitiveTest | author,
                          ~ 1 | author),
            struct="CS",
            data=D,
            slab=sprintf("%s: %s (%s)", author, cognitiveDomain, cognitiveTest))
```

```{r, results='asis'}
summary <- data.frame(M[c("b", "se", "zval", "pval", "ci.lb", "ci.ub")])
rownames(summary) <- gsub("cognitiveDomain", "", rownames(summary))
print(xtable(summary, digits=c(0, rep(3, 3), 4, rep(3, 2))), type="html")
```

```{r}
summary(M)
```


Save working data tables to file.

```{r}
metadata <- makeMetadata(D)
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment.RData")
save(D, metadata, M, summary, file=f)
message(sprintf("%s saved on: %s\nFile size: %s KB", 
                f,
                file.mtime(f),
                file.size(f) / 1e3))
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment-Data.csv")
write.csv(D, file=f, row.names=FALSE)
f <- sprintf("%s/%s", pathOut, "metaAnalysisCognitiveImpairment-summary.csv")
write.csv(summary, file=f, row.names=FALSE)
```


## Plot of effect sizes

The `xlim` settings require fine-tuning.

```{r, echo=FALSE}
lower <- D$yi + qnorm(0.025) * sqrt(D$vi)
upper <- D$yi + qnorm(0.975) * sqrt(D$vi)
alim <- c(floor(min(lower, na.rm=TRUE)), ceiling(max(upper, na.rm=TRUE)))
xlim <- c(-20, 9)
at <- seq(floor(min(lower, na.rm=TRUE)), ceiling(max(upper, na.rm=TRUE)), 1)
```

```{r forest, echo=FALSE, fig.width=10, fig.height=30}
f <- sprintf("%s/%s", pathOut, "forest.png")
png(f, width=10, height=30, units="in", res=300)
forest(M, mlab="Pooled random effect", alim=alim, xlim=xlim, at=at, order="obs")
dev.off()
forest(M, mlab="Pooled random effect", alim=alim, xlim=xlim, at=at, order="obs")
```

Full resolution file is [here](Output/forest.png).


## Plot to assess publication bias

See [*BMJ* 2011;342:d4002](http://www.bmj.com/content/343/bmj.d4002) for a guide to interpret funnel plots.

```{r funnel, echo=FALSE}
funnel(M)
```
